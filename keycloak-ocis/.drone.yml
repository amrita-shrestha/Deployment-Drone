---
{"kind": "pipeline", "type": "docker", "name": "start-services", "steps": [{"name": "wait-for-postgres", "image": "owncloudci/wait-for:latest", "commands": ["wait-for -it postgres:5432 -t 300"]}, {"name": "keycloak", "image": "quay.io/keycloak/keycloak:22.0.4", "detach": true, "environment": {"OCIS_DOMAIN": "ocis:9200", "KC_HOSTNAME": "keycloak:8443", "KC_DB": "postgres", "KC_DB_URL": "jdbc:postgresql://postgres:5432/keycloak", "KC_DB_USERNAME": "keycloak", "KC_DB_PASSWORD": "keycloak", "KC_FEATURES": "impersonation", "KEYCLOAK_ADMIN": "admin", "KEYCLOAK_ADMIN_PASSWORD": "admin", "KC_HTTPS_CERTIFICATE_FILE": "./keycloak-certs/keycloakcrt.pem", "KC_HTTPS_CERTIFICATE_KEY_FILE": "./keycloak-certs/keycloakkey.pem"}, "commands": ["cat keycloak-certs/keycloakkey.pem", "ls -al", "pwd", "ls -al", "mkdir -p /opt/keycloak/data/import", "cp ocis-realm.dist.json /opt/keycloak/data/import/ocis-realm.json", "/opt/keycloak/bin/kc.sh start-dev --proxy edge --spi-connections-http-client-default-disable-trust-manager=false --import-realm --health-enabled=true"], "volumes": [{"name": "certs", "path": "keycloak-certs"}]}, {"name": "wait-for-keycloak", "image": "owncloudci/wait-for:latest", "commands": ["wait-for -it keycloak:8443 -t 300"]}, {"name": "clone-ocis", "image": "owncloudci/golang:1.22", "commands": ["git clone -b master --single-branch https://github.com/owncloud/ocis.git", "cd ocis"]}, {"name": "generate-ocis", "image": "owncloudci/nodejs:18", "commands": ["cd ocis", "retry -t 3 'make ci-node-generate'"]}, {"name": "build-ocis", "image": "owncloudci/golang:1.22", "commands": ["cd ocis/ocis", "retry -t 3 'make build'"]}, {"name": "ocis", "image": "owncloudci/golang:1.22", "detach": true, "environment": {"OCIS_URL": "https://ocis:9200", "OCIS_LOG_LEVEL": "error", "IDM_ADMIN_PASSWORD": "admin", "PROXY_AUTOPROVISION_ACCOUNTS": "true", "PROXY_ROLE_ASSIGNMENT_DRIVER": "oidc", "OCIS_OIDC_ISSUER": "https://keycloak:8443/realms/oCIS", "PROXY_OIDC_REWRITE_WELLKNOWN": "true", "WEB_OIDC_CLIENT_ID": "web", "PROXY_USER_OIDC_CLAIM": "preferred_username", "PROXY_USER_CS3_CLAIM": "username", "OCIS_ADMIN_USER_ID": "", "OCIS_EXCLUDE_RUN_SERVICES": "idp", "GRAPH_ASSIGN_DEFAULT_USER_ROLE": "false", "GRAPH_USERNAME_MATCH": "none", "WEB_ASSET_PATH": "web/dist"}, "commands": ["ocis/ocis/bin/ocis init --insecure true", "ocis/ocis/bin/ocis server"]}, {"name": "wait-for-ocis-server", "image": "owncloudci/wait-for:latest", "commands": ["wait-for -it ocis:9200 -t 300"]}, {"name": "e2e-tests", "image": "owncloudci/nodejs:18", "environment": {"BASE_URL_OCIS": "ocis:9200", "HEADLESS": "true", "RETRY": "1", "REPORT_TRACING": "true", "KEYCLOAK": "true", "KEYCLOAK_HOST": "keycloak:8443"}, "commands": ["cd web", "pnpm test:e2e:cucumber tests/e2e/cucumber/features/smoke/admin-settings/users.feature:20", "pnpm test:e2e:cucumber tests/e2e/cucumber/features/smoke/admin-settings/spaces.feature", "pnpm test:e2e:cucumber tests/e2e/cucumber/features/journey"]}], "services": [{"name": "postgres", "image": "postgres:alpine3.18", "environment": {"POSTGRES_DB": "keycloak", "POSTGRES_USER": "keycloak", "POSTGRES_PASSWORD": "keycloak"}}], "trigger": {"ref": ["refs/heads/master", "refs/heads/stable-*", "refs/tags/**", "refs/pull/**"]}}
